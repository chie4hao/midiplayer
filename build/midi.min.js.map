{"version":3,"sources":["midi.min.js","../../../AppData/Roaming/npm/node_modules/browserify/node_modules/browser-pack/_prelude.js","js/midi/loader.js","js/midi/midi.js","js/midi/player.js","js/midi/stream.js","main.js"],"names":["e","t","n","r","s","o","u","a","require","i","f","Error","code","l","exports","call","length","1","module","MIDI","loadMidiFile","midiFile","callback","readBlobAsDataURL","file","FileReader","readAsDataURL","onloadend","target","result","constructor","toString","indexOf","dataurl","midiTracks","intoTracks","intoTemporal","MIDIPlayer","loadSondFont","./midi.js","2","Stream","this","midiDataurl","header","tracks","temporal","beatsPerMinute","prototype","atob","split","u8arr","charCodeAt","stream","console","log","readWord","headerStream","read","readInt32","formatType","readInt16","trackCount","ticksPerBeat","trackStream","eof","event","readEvent","push","currentTime","currentDeltaTime","minTime","trackId","deltaTime","Infinity","tracksCurrentState","position","_i","nextEvent","type","subtype","microsecondsPerBeat","lastEventTypeByte","readVarInt","eventTypeByte","readInt8","subtypeByte","number","text","channel","hourByte","frameRate","0","32","64","96","hour","min","sec","frame","subframe","numerator","denominator","Math","pow","metronome","thirtyseconds","key","scale","data","_length","_length2","param1","eventType","noteNumber","velocity","amount","controllerType","value","programNumber","./stream","3","global","loadAudio","instrument","index","bstr","soundFont","buffer","ArrayBuffer","Uint8Array","ctx","decodeAudioData","buffer1","id","keyToNote","audioBuffers","decodeLength","soundFontLength","playTime","beginTime","masterVolume","sources","currentPlayer","sendSignal","x","y","current","noteOn","noteOff","time","currentTimeout","setTimeout","noteId","delay","source","createBufferSource","ouput","createGain","connect","destination","gain","max","start","linearRampToValueAtTime","stopAllNotes","clearPlayer","forEach","clearTimeout","window","AudioContext","noteToKey","A0","C8","number2key","octave","name","Soundfont","xhr","XMLHttpRequest","open","onreadystatechange","evt","readyState","status","root","client","cordova","script","document","createElement","language","responseText","body","appendChild","Object","keys","onerror","send","self","4","str","str1","String","fromCharCode","slice","signed","b","5","./js/midi/loader.js","./js/midi/player.js"],"mappings":"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","file":"midi.min.js","sourcesContent":["(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n/**\r\n * Created by chie on 2016/2/26.\r\n */\r\nconst MIDI = require('./midi.js');\r\nconst loadMidiFile = (midiFile, callback) => {\r\n    const readBlobAsDataURL = (file, callback) => {\r\n        let a = new FileReader();\r\n        a.readAsDataURL(file);\r\n        a.onloadend = e =>callback(e.target.result);\r\n    };\r\n    if (midiFile.constructor.toString().indexOf('File') != -1 || midiFile.constructor.toString().indexOf('Blob') != -1) {\r\n        readBlobAsDataURL(midiFile, dataurl => {\r\n            loadMidiFile.midiTracks = new MIDI(dataurl);\r\n            loadMidiFile.midiTracks.intoTracks();\r\n            loadMidiFile.midiTracks.intoTemporal();\r\n            //暂时只支持acoustic_grand_piano\r\n            MIDIPlayer.loadSondFont('acoustic_grand_piano', () =>\r\n                callback(loadMidiFile.midiTracks)\r\n            );\r\n        });\r\n    }\r\n};\r\nloadMidiFile.midiTracks = {};\r\n\r\nmodule.exports = loadMidiFile;\n},{\"./midi.js\":2}],2:[function(require,module,exports){\n/**\r\n * Created by chie on 2016/4/25.\r\n */\r\n\r\n\r\nconst Stream=require('./stream');\r\n\r\nconst MIDI = function (dataurl) {\r\n    this.midiDataurl = dataurl;\r\n    this.header={};\r\n    this.tracks = [];\r\n    this.temporal = [];\r\n    this.beatsPerMinute = 120;\r\n}\r\n\r\nMIDI.prototype = {\r\n    //转为多轨序列\r\n    intoTracks: function () {\r\n        if (!this.midiDataurl) {\r\n            throw 'midiDateurl is null'\r\n        }\r\n        let dataurl = atob(this.midiDataurl.split(',')[1]);\r\n        let n = dataurl.length, u8arr = [];\r\n        while (n--) {\r\n            u8arr[n] = dataurl.charCodeAt(n);\r\n        }\r\n        /*\r\n         let n = dataurl.length;\r\n         let array16 = [];\r\n         while (n--) {\r\n         array16[n] = u8arr[n].toString(16);\r\n         }\r\n         */\r\n        let stream = Stream(u8arr);\r\n        console.log(stream.readWord(4))\r\n        let headerStream = Stream(stream.read(stream.readInt32()));\r\n        this.header.formatType = headerStream.readInt16();\r\n        this.header.trackCount = headerStream.readInt16();\r\n        this.header.ticksPerBeat = headerStream.readInt16();\r\n\r\n        //分轨\r\n        for (let i = 0; i < this.header.trackCount; i++) {\r\n            this.tracks[i] = [];\r\n            console.log(stream.readWord(4))\r\n            let trackStream = Stream(stream.read(stream.readInt32()));\r\n            while (!trackStream.eof()) {\r\n                let event = readEvent(trackStream);\r\n                this.tracks[i].push(event);\r\n            }\r\n        }\r\n    },\r\n    //转为单轨序列\r\n    intoTemporal: function () {\r\n        let currentTime = 0;\r\n        let currentDeltaTime = 0;\r\n        let minTime = {\r\n            trackId: 0,\r\n            deltaTime: Infinity\r\n        };\r\n        let tracksCurrentState = []\r\n        for (let i = 0; i < this.tracks.length; i++) {\r\n            tracksCurrentState[i] = {\r\n                position: 0,\r\n                deltaTime: 0\r\n            };\r\n        }\r\n        while (1) {\r\n            minTime.deltaTime = Infinity;\r\n            for (let i = 0; i < this.tracks.length; i++) {\r\n                if (this.tracks[i][tracksCurrentState[i].position] && this.tracks[i][tracksCurrentState[i].position].deltaTime + tracksCurrentState[i].deltaTime < minTime.deltaTime) {\r\n                    minTime.trackId = i;\r\n                    minTime.deltaTime = this.tracks[i][tracksCurrentState[i].position].deltaTime + tracksCurrentState[i].deltaTime;\r\n                }\r\n            }\r\n            if (minTime.deltaTime != Infinity) {\r\n                let nextEvent = this.tracks[minTime.trackId][tracksCurrentState[minTime.trackId].position];\r\n                this.temporal.push([nextEvent, currentTime += (minTime.deltaTime - currentDeltaTime) / this.header.ticksPerBeat / (this.beatsPerMinute / 60)]);\r\n                tracksCurrentState[minTime.trackId].position++;\r\n                tracksCurrentState[minTime.trackId].deltaTime = minTime.deltaTime;\r\n                currentDeltaTime = tracksCurrentState[minTime.trackId].deltaTime;\r\n                if (nextEvent.type == \"meta\" && nextEvent.subtype == \"setTempo\") {\r\n                    this.beatsPerMinute = 60000000 / nextEvent.microsecondsPerBeat\r\n                }\r\n            } else break;\r\n        }\r\n    }\r\n};\r\n\r\n\r\nlet lastEventTypeByte;\r\n\r\nconst readEvent = function (stream) {\r\n    let event = {};\r\n    event.deltaTime = stream.readVarInt();\r\n    let eventTypeByte = stream.readInt8();\r\n    if ((eventTypeByte & 0xf0) == 0xf0) {\r\n        /* system / meta event */\r\n        if (eventTypeByte == 0xff) {\r\n            /* meta event */\r\n            event.type = 'meta';\r\n            let subtypeByte = stream.readInt8();\r\n            let length = stream.readVarInt();\r\n            switch (subtypeByte) {\r\n                case 0x00:\r\n                    event.subtype = 'sequenceNumber';\r\n                    if (length != 2) throw \"Expected length for sequenceNumber event is 2, got \" + length;\r\n                    event.number = stream.readInt16();\r\n                    return event;\r\n                case 0x01:\r\n                    event.subtype = 'text';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x02:\r\n                    event.subtype = 'copyrightNotice';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x03:\r\n                    event.subtype = 'trackName';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x04:\r\n                    event.subtype = 'instrumentName';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x05:\r\n                    event.subtype = 'lyrics';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x06:\r\n                    event.subtype = 'marker';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x07:\r\n                    event.subtype = 'cuePoint';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x20:\r\n                    event.subtype = 'midiChannelPrefix';\r\n                    if (length != 1) throw \"Expected length for midiChannelPrefix event is 1, got \" + length;\r\n                    event.channel = stream.readInt8();\r\n                    return event;\r\n                case 0x2f:\r\n                    event.subtype = 'endOfTrack';\r\n                    if (length != 0) throw \"Expected length for endOfTrack event is 0, got \" + length;\r\n                    return event;\r\n                case 0x51:\r\n                    event.subtype = 'setTempo';\r\n                    if (length != 3) throw \"Expected length for setTempo event is 3, got \" + length;\r\n                    event.microsecondsPerBeat = (\r\n                        (stream.readInt8() << 16)\r\n                        + (stream.readInt8() << 8)\r\n                        + stream.readInt8()\r\n                    )\r\n                    return event;\r\n                case 0x54:\r\n                    event.subtype = 'smpteOffset';\r\n                    if (length != 5) throw \"Expected length for smpteOffset event is 5, got \" + length;\r\n                    let hourByte = stream.readInt8();\r\n                    event.frameRate = {\r\n                        0x00: 24, 0x20: 25, 0x40: 29, 0x60: 30\r\n                    }[hourByte & 0x60];\r\n                    event.hour = hourByte & 0x1f;\r\n                    event.min = stream.readInt8();\r\n                    event.sec = stream.readInt8();\r\n                    event.frame = stream.readInt8();\r\n                    event.subframe = stream.readInt8();\r\n                    return event;\r\n                case 0x58:\r\n                    event.subtype = 'timeSignature';\r\n                    if (length != 4) throw \"Expected length for timeSignature event is 4, got \" + length;\r\n                    event.numerator = stream.readInt8();\r\n                    event.denominator = Math.pow(2, stream.readInt8());\r\n                    event.metronome = stream.readInt8();\r\n                    event.thirtyseconds = stream.readInt8();\r\n                    return event;\r\n                case 0x59:\r\n                    event.subtype = 'keySignature';\r\n                    if (length != 2) throw \"Expected length for keySignature event is 2, got \" + length;\r\n                    event.key = stream.readInt8(true);\r\n                    event.scale = stream.readInt8();\r\n                    return event;\r\n                case 0x7f:\r\n                    event.subtype = 'sequencerSpecific';\r\n                    event.data = stream.read(length);\r\n                    return event;\r\n                default:\r\n                    // console.log(\"Unrecognised meta event subtype: \" + subtypeByte);\r\n                    event.subtype = 'unknown'\r\n                    event.data = stream.read(length);\r\n                    return event;\r\n            }\r\n            event.data = stream.read(length);\r\n            return event;\r\n        } else if (eventTypeByte == 0xf0) {\r\n            event.type = 'sysEx';\r\n            let length = stream.readVarInt();\r\n            event.data = stream.read(length);\r\n            return event;\r\n        } else if (eventTypeByte == 0xf7) {\r\n            event.type = 'dividedSysEx';\r\n            let length = stream.readVarInt();\r\n            event.data = stream.read(length);\r\n            return event;\r\n        } else {\r\n            throw \"Unrecognised MIDI event type byte: \" + eventTypeByte;\r\n        }\r\n    } else {\r\n        /* channel event */\r\n        let param1;\r\n        if ((eventTypeByte & 0x80) == 0) {\r\n\r\n            param1 = eventTypeByte;\r\n            eventTypeByte = lastEventTypeByte;\r\n        } else {\r\n            param1 = stream.readInt8();\r\n            lastEventTypeByte = eventTypeByte;\r\n        }\r\n        let eventType = eventTypeByte >> 4;\r\n        event.channel = eventTypeByte & 0x0f;\r\n        event.type = 'channel';\r\n        switch (eventType) {\r\n            case 0x08:\r\n                event.subtype = 'noteOff';\r\n                event.noteNumber = param1;\r\n                event.velocity = stream.readInt8();\r\n                return event;\r\n            case 0x09:\r\n                event.noteNumber = param1;\r\n                event.velocity = stream.readInt8();\r\n                if (event.velocity == 0) {\r\n                    event.subtype = 'noteOff';\r\n                } else {\r\n                    event.subtype = 'noteOn';\r\n                }\r\n                return event;\r\n            case 0x0a:\r\n                event.subtype = 'noteAftertouch';\r\n                event.noteNumber = param1;\r\n                event.amount = stream.readInt8();\r\n                return event;\r\n            case 0x0b:\r\n                event.subtype = 'controller';\r\n                event.controllerType = param1;\r\n                event.value = stream.readInt8();\r\n                return event;\r\n            case 0x0c:\r\n                event.subtype = 'programChange';\r\n                event.programNumber = param1;\r\n                return event;\r\n            case 0x0d:\r\n                event.subtype = 'channelAftertouch';\r\n                event.amount = param1;\r\n                return event;\r\n            case 0x0e:\r\n                event.subtype = 'pitchBend';\r\n                event.value = param1 + (stream.readInt8() << 7);\r\n                return event;\r\n            default:\r\n                throw \"Unrecognised MIDI event type: \" + eventType\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports=MIDI;\n},{\"./stream\":4}],3:[function(require,module,exports){\n(function (global){\n/**\r\n * Created by chie on 2016/4/25.\r\n */\r\n\r\n\r\nlet MIDIPlayer = function (midiTracks) {\r\n    this.temporal = midiTracks.temporal;\r\n    this.playTime = ctx.currentTime;\r\n    this.beginTime = this.playTime;\r\n    this.masterVolume = 127;\r\n    this.sources = {};\r\n    MIDIPlayer.currentPlayer.push(this);\r\n}\r\n\r\nMIDIPlayer.prototype.sendSignal = function (x, y) {\r\n    y = y || 5;\r\n    let current = this;\r\n    for (let i = x; i < this.temporal.length && i < x + y; i++) {\r\n        switch (this.temporal[i][0].subtype) {\r\n            case 'noteOn':\r\n                this.noteOn('acoustic_grand_piano', this.temporal[i][0].noteNumber, this.temporal[i][0].velocity, this.temporal[i][1])\r\n                break;\r\n            case 'noteOff':\r\n                this.noteOff('acoustic_grand_piano', this.temporal[i][0].noteNumber, this.temporal[i][1]);\r\n                break;\r\n        }\r\n    }\r\n\r\n    if ((x + y) < this.temporal.length) {\r\n        let time = (this.temporal[(x + y)][1] - ctx.currentTime + this.beginTime) * 1000 - 500;\r\n        this.currentTimeout = setTimeout(function () {\r\n            current.playTime = ctx.currentTime;\r\n            current.sendSignal(x + y, y);\r\n        }, time);\r\n    }\r\n}\r\n\r\nMIDIPlayer.prototype.noteOn = function (instrument, noteId, velocity, delay) {\r\n    let source = ctx.createBufferSource();\r\n    source.buffer = audioBuffers[instrument + ' ' + noteId];\r\n    let ouput = ctx.createGain();\r\n    ouput.connect(ctx.destination);\r\n    ouput.gain.value = Math.min(1.0, Math.max(-1.0, (velocity / 127) * (this.masterVolume / 127)));\r\n    source.gain = ouput;\r\n    source.connect(ouput);\r\n    //此处可添加音频效果器\r\n    /*\r\n     var feedbackNode = ctx.createGain();\r\n     feedbackNode.gain.value = 1;\r\n\r\n     var filter = ctx.createBiquadFilter();\r\n     filter.frequency.value = 1000;\r\n\r\n     var delayNode = ctx.createDelay();\r\n     delayNode.delayTime.value = 0.15;\r\n\r\n     delayNode.connect(filter);\r\n     filter.connect(feedbackNode)\r\n\r\n     source.connect(delayNode);\r\n\r\n     feedbackNode.connect(ouput);\r\n     */\r\n    delay = delay - ctx.currentTime + this.playTime + this.beginTime\r\n    source.start(delay);\r\n    this.sources[noteId] = source;\r\n};\r\n\r\nMIDIPlayer.prototype.noteOff = function (instrument, noteId, delay) {\r\n    let buffer = audioBuffers[instrument + ' ' + noteId];\r\n    if (buffer) {\r\n        let source = this.sources[noteId];\r\n        if (source) {\r\n            delay = delay - ctx.currentTime + this.playTime + this.beginTime\r\n\r\n            if (source.gain) {\r\n                var gain = source.gain.gain;\r\n                gain.linearRampToValueAtTime(gain.value, delay);\r\n                gain.linearRampToValueAtTime(0, delay + 0.3);\r\n            }\r\n            this.sources[noteId] = null;\r\n            return source;\r\n        }\r\n    }\r\n}\r\n\r\nMIDIPlayer.prototype.stopAllNotes = function () {\r\n    for (var a in this.sources) {\r\n        var source = this.sources[a];\r\n        if (source && source.gain) {\r\n            var gain = source.gain.gain;\r\n            gain.linearRampToValueAtTime(gain.value, 0);\r\n            gain.linearRampToValueAtTime(0, 0 + 0.3);\r\n            source = null;\r\n        }\r\n    }\r\n}\r\n\r\nMIDIPlayer.currentPlayer = [];\r\n\r\nMIDIPlayer.clearPlayer = function () {\r\n    MIDIPlayer.currentPlayer.forEach(function (a) {\r\n        clearTimeout(a.currentTimeout)\r\n        //静音\r\n        a.stopAllNotes();\r\n    });\r\n    MIDIPlayer.currentPlayer = [];\r\n}\r\n\r\nglobal.ctx = new window.AudioContext();\r\nvar soundFont;\r\nvar audioBuffers = {};\r\nvar soundFontLength, decodeLength;\r\nvar keyToNote = {}; // C8  == 108\r\nvar noteToKey = {}; // 108 ==  C8\r\n\r\n(function () {\r\n    var A0 = 0x15; // first note\r\n    var C8 = 0x6C; // last note\r\n    var number2key = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];\r\n    for (var n = A0; n <= C8; n++) {\r\n        var octave = (n - 12) / 12 >> 0;\r\n        var name = number2key[n % 12] + octave;\r\n        keyToNote[name] = n;\r\n        noteToKey[n] = name;\r\n    }\r\n})();\r\n\r\nMIDIPlayer.loadSondFont = function (instrument, callback) {\r\n    instrument = instrument || 'acoustic_grand_piano';\r\n    decodeLength = 0;\r\n\r\n    if (typeof MIDI !== 'undefined' && MIDI.Soundfont[instrument]) { // already loaded\r\n        console.log('already cached')\r\n        callback();\r\n    } else {\r\n        var xhr = new XMLHttpRequest();\r\n\r\n        //自行更改soundfont地址\r\n        xhr.open('GET', './js/soundfont/' + instrument + '-mp3.js', true);\r\n        \r\n        xhr.onreadystatechange = function (evt) {\r\n            if (xhr.readyState === 4) {\r\n                if (xhr.status === 200 ||\r\n                    xhr.status === 304 ||    // Not Modified\r\n                    xhr.status === 308 ||    // Permanent Redirect\r\n                    xhr.status === 0 && root.client.cordova // Cordova quirk\r\n                ) {\r\n                    var script = document.createElement('script');\r\n                    script.language = 'javascript';\r\n                    script.type = 'text/javascript';\r\n                    script.text = evt.target.responseText;\r\n                    document.body.appendChild(script);\r\n                    soundFont = MIDI.Soundfont[instrument]\r\n                    soundFontLength = Object.keys(soundFont).length;\r\n                    for (var index in soundFont) {\r\n                        loadAudio(instrument, index, callback);\r\n                    }\r\n                } else {\r\n                    onerror && onerror.call(xhr, evt);\r\n                }\r\n            }\r\n        }\r\n        xhr.send();\r\n    }\r\n}\r\n\r\nfunction loadAudio(instrument, index, callback) {\r\n    var bstr = atob(soundFont[index].split(',')[1]), n = bstr.length, buffer = new ArrayBuffer(n), u8arr = new Uint8Array(buffer);\r\n    while (n--) {\r\n        u8arr[n] = bstr.charCodeAt(n);\r\n    }\r\n    ctx.decodeAudioData(buffer, function (buffer1) {\r\n        buffer1.id = keyToNote[index]\r\n        if (buffer1.id) {\r\n            audioBuffers[instrument + ' ' + buffer1.id] = buffer1;\r\n        }\r\n        if (++decodeLength === soundFontLength) {\r\n            console.log(\"finish\")\r\n            callback();\r\n        }\r\n    })\r\n}\r\n\r\nmodule.exports = MIDIPlayer;\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n\n},{}],4:[function(require,module,exports){\n/**\r\n * Created by chie on 2016/2/25.\r\n */\r\nfunction Stream(str) {\r\n    var position = 0;\r\n    \r\n    function readWord(length) {\r\n        \r\n        var str1=''\r\n        for(var i=0;i<length;i++){\r\n            str1+=String.fromCharCode(str[position+i])\r\n        }\r\n        position+=length;\r\n        return str1;\r\n    }\r\n    function read(length){\r\n        position+=length;\r\n        return str.slice(position-length,position)\r\n    }\r\n    //读32位，以此类推\r\n    function readInt32() {\r\n        var result = (\r\n        (str[position] << 24)\r\n        + (str[position + 1] << 16)\r\n        + (str[position + 2] << 8)\r\n        + str[position + 3]);\r\n        position += 4;\r\n        return result;\r\n    }\r\n\r\n    function readInt16() {\r\n        var result = (\r\n        (str[position] << 8)\r\n        + str[position + 1]);\r\n        position += 2;\r\n        return result;\r\n    }\r\n\r\n    function readInt8(signed) {\r\n        var result = str[position];\r\n        if (signed && result > 127) result -= 256;\r\n        position += 1;\r\n        return result;\r\n    }\r\n\r\n    function eof() {\r\n        return position >= str.length;\r\n    }\r\n    //读变长\r\n    function readVarInt() {\r\n        var result = 0;\r\n        while (true) {\r\n            var b = readInt8();\r\n            if (b & 0x80) {\r\n                result += (b & 0x7f);\r\n                result <<= 7;\r\n            } else {\r\n                return result + b;\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        'eof': eof,\r\n        'read': read,\r\n        'readInt32': readInt32,\r\n        'readInt16': readInt16,\r\n        'readInt8': readInt8,\r\n        'readVarInt': readVarInt,\r\n        'readWord':readWord\r\n    }\r\n}\r\n\r\nmodule.exports=Stream;\n},{}],5:[function(require,module,exports){\n(function (global){\n/**\r\n * Created by chie on 2016/5/21.\r\n */\r\n\r\nglobal.MIDIPlayer=require('./js/midi/player.js');\r\nglobal.loadMidiFile=require('./js/midi/loader.js');\n}).call(this,typeof global !== \"undefined\" ? global : typeof self !== \"undefined\" ? self : typeof window !== \"undefined\" ? window : {})\n\n},{\"./js/midi/loader.js\":1,\"./js/midi/player.js\":3}]},{},[5])\n\n","(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})","/**\r\n * Created by chie on 2016/2/26.\r\n */\r\nconst MIDI = require('./midi.js');\r\nconst loadMidiFile = (midiFile, callback) => {\r\n    const readBlobAsDataURL = (file, callback) => {\r\n        let a = new FileReader();\r\n        a.readAsDataURL(file);\r\n        a.onloadend = e =>callback(e.target.result);\r\n    };\r\n    if (midiFile.constructor.toString().indexOf('File') != -1 || midiFile.constructor.toString().indexOf('Blob') != -1) {\r\n        readBlobAsDataURL(midiFile, dataurl => {\r\n            loadMidiFile.midiTracks = new MIDI(dataurl);\r\n            loadMidiFile.midiTracks.intoTracks();\r\n            loadMidiFile.midiTracks.intoTemporal();\r\n            //暂时只支持acoustic_grand_piano\r\n            MIDIPlayer.loadSondFont('acoustic_grand_piano', () =>\r\n                callback(loadMidiFile.midiTracks)\r\n            );\r\n        });\r\n    }\r\n};\r\nloadMidiFile.midiTracks = {};\r\n\r\nmodule.exports = loadMidiFile;","/**\r\n * Created by chie on 2016/4/25.\r\n */\r\n\r\n\r\nconst Stream=require('./stream');\r\n\r\nconst MIDI = function (dataurl) {\r\n    this.midiDataurl = dataurl;\r\n    this.header={};\r\n    this.tracks = [];\r\n    this.temporal = [];\r\n    this.beatsPerMinute = 120;\r\n}\r\n\r\nMIDI.prototype = {\r\n    //转为多轨序列\r\n    intoTracks: function () {\r\n        if (!this.midiDataurl) {\r\n            throw 'midiDateurl is null'\r\n        }\r\n        let dataurl = atob(this.midiDataurl.split(',')[1]);\r\n        let n = dataurl.length, u8arr = [];\r\n        while (n--) {\r\n            u8arr[n] = dataurl.charCodeAt(n);\r\n        }\r\n        /*\r\n         let n = dataurl.length;\r\n         let array16 = [];\r\n         while (n--) {\r\n         array16[n] = u8arr[n].toString(16);\r\n         }\r\n         */\r\n        let stream = Stream(u8arr);\r\n        console.log(stream.readWord(4))\r\n        let headerStream = Stream(stream.read(stream.readInt32()));\r\n        this.header.formatType = headerStream.readInt16();\r\n        this.header.trackCount = headerStream.readInt16();\r\n        this.header.ticksPerBeat = headerStream.readInt16();\r\n\r\n        //分轨\r\n        for (let i = 0; i < this.header.trackCount; i++) {\r\n            this.tracks[i] = [];\r\n            console.log(stream.readWord(4))\r\n            let trackStream = Stream(stream.read(stream.readInt32()));\r\n            while (!trackStream.eof()) {\r\n                let event = readEvent(trackStream);\r\n                this.tracks[i].push(event);\r\n            }\r\n        }\r\n    },\r\n    //转为单轨序列\r\n    intoTemporal: function () {\r\n        let currentTime = 0;\r\n        let currentDeltaTime = 0;\r\n        let minTime = {\r\n            trackId: 0,\r\n            deltaTime: Infinity\r\n        };\r\n        let tracksCurrentState = []\r\n        for (let i = 0; i < this.tracks.length; i++) {\r\n            tracksCurrentState[i] = {\r\n                position: 0,\r\n                deltaTime: 0\r\n            };\r\n        }\r\n        while (1) {\r\n            minTime.deltaTime = Infinity;\r\n            for (let i = 0; i < this.tracks.length; i++) {\r\n                if (this.tracks[i][tracksCurrentState[i].position] && this.tracks[i][tracksCurrentState[i].position].deltaTime + tracksCurrentState[i].deltaTime < minTime.deltaTime) {\r\n                    minTime.trackId = i;\r\n                    minTime.deltaTime = this.tracks[i][tracksCurrentState[i].position].deltaTime + tracksCurrentState[i].deltaTime;\r\n                }\r\n            }\r\n            if (minTime.deltaTime != Infinity) {\r\n                let nextEvent = this.tracks[minTime.trackId][tracksCurrentState[minTime.trackId].position];\r\n                this.temporal.push([nextEvent, currentTime += (minTime.deltaTime - currentDeltaTime) / this.header.ticksPerBeat / (this.beatsPerMinute / 60)]);\r\n                tracksCurrentState[minTime.trackId].position++;\r\n                tracksCurrentState[minTime.trackId].deltaTime = minTime.deltaTime;\r\n                currentDeltaTime = tracksCurrentState[minTime.trackId].deltaTime;\r\n                if (nextEvent.type == \"meta\" && nextEvent.subtype == \"setTempo\") {\r\n                    this.beatsPerMinute = 60000000 / nextEvent.microsecondsPerBeat\r\n                }\r\n            } else break;\r\n        }\r\n    }\r\n};\r\n\r\n\r\nlet lastEventTypeByte;\r\n\r\nconst readEvent = function (stream) {\r\n    let event = {};\r\n    event.deltaTime = stream.readVarInt();\r\n    let eventTypeByte = stream.readInt8();\r\n    if ((eventTypeByte & 0xf0) == 0xf0) {\r\n        /* system / meta event */\r\n        if (eventTypeByte == 0xff) {\r\n            /* meta event */\r\n            event.type = 'meta';\r\n            let subtypeByte = stream.readInt8();\r\n            let length = stream.readVarInt();\r\n            switch (subtypeByte) {\r\n                case 0x00:\r\n                    event.subtype = 'sequenceNumber';\r\n                    if (length != 2) throw \"Expected length for sequenceNumber event is 2, got \" + length;\r\n                    event.number = stream.readInt16();\r\n                    return event;\r\n                case 0x01:\r\n                    event.subtype = 'text';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x02:\r\n                    event.subtype = 'copyrightNotice';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x03:\r\n                    event.subtype = 'trackName';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x04:\r\n                    event.subtype = 'instrumentName';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x05:\r\n                    event.subtype = 'lyrics';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x06:\r\n                    event.subtype = 'marker';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x07:\r\n                    event.subtype = 'cuePoint';\r\n                    event.text = stream.read(length);\r\n                    return event;\r\n                case 0x20:\r\n                    event.subtype = 'midiChannelPrefix';\r\n                    if (length != 1) throw \"Expected length for midiChannelPrefix event is 1, got \" + length;\r\n                    event.channel = stream.readInt8();\r\n                    return event;\r\n                case 0x2f:\r\n                    event.subtype = 'endOfTrack';\r\n                    if (length != 0) throw \"Expected length for endOfTrack event is 0, got \" + length;\r\n                    return event;\r\n                case 0x51:\r\n                    event.subtype = 'setTempo';\r\n                    if (length != 3) throw \"Expected length for setTempo event is 3, got \" + length;\r\n                    event.microsecondsPerBeat = (\r\n                        (stream.readInt8() << 16)\r\n                        + (stream.readInt8() << 8)\r\n                        + stream.readInt8()\r\n                    )\r\n                    return event;\r\n                case 0x54:\r\n                    event.subtype = 'smpteOffset';\r\n                    if (length != 5) throw \"Expected length for smpteOffset event is 5, got \" + length;\r\n                    let hourByte = stream.readInt8();\r\n                    event.frameRate = {\r\n                        0x00: 24, 0x20: 25, 0x40: 29, 0x60: 30\r\n                    }[hourByte & 0x60];\r\n                    event.hour = hourByte & 0x1f;\r\n                    event.min = stream.readInt8();\r\n                    event.sec = stream.readInt8();\r\n                    event.frame = stream.readInt8();\r\n                    event.subframe = stream.readInt8();\r\n                    return event;\r\n                case 0x58:\r\n                    event.subtype = 'timeSignature';\r\n                    if (length != 4) throw \"Expected length for timeSignature event is 4, got \" + length;\r\n                    event.numerator = stream.readInt8();\r\n                    event.denominator = Math.pow(2, stream.readInt8());\r\n                    event.metronome = stream.readInt8();\r\n                    event.thirtyseconds = stream.readInt8();\r\n                    return event;\r\n                case 0x59:\r\n                    event.subtype = 'keySignature';\r\n                    if (length != 2) throw \"Expected length for keySignature event is 2, got \" + length;\r\n                    event.key = stream.readInt8(true);\r\n                    event.scale = stream.readInt8();\r\n                    return event;\r\n                case 0x7f:\r\n                    event.subtype = 'sequencerSpecific';\r\n                    event.data = stream.read(length);\r\n                    return event;\r\n                default:\r\n                    // console.log(\"Unrecognised meta event subtype: \" + subtypeByte);\r\n                    event.subtype = 'unknown'\r\n                    event.data = stream.read(length);\r\n                    return event;\r\n            }\r\n            event.data = stream.read(length);\r\n            return event;\r\n        } else if (eventTypeByte == 0xf0) {\r\n            event.type = 'sysEx';\r\n            let length = stream.readVarInt();\r\n            event.data = stream.read(length);\r\n            return event;\r\n        } else if (eventTypeByte == 0xf7) {\r\n            event.type = 'dividedSysEx';\r\n            let length = stream.readVarInt();\r\n            event.data = stream.read(length);\r\n            return event;\r\n        } else {\r\n            throw \"Unrecognised MIDI event type byte: \" + eventTypeByte;\r\n        }\r\n    } else {\r\n        /* channel event */\r\n        let param1;\r\n        if ((eventTypeByte & 0x80) == 0) {\r\n\r\n            param1 = eventTypeByte;\r\n            eventTypeByte = lastEventTypeByte;\r\n        } else {\r\n            param1 = stream.readInt8();\r\n            lastEventTypeByte = eventTypeByte;\r\n        }\r\n        let eventType = eventTypeByte >> 4;\r\n        event.channel = eventTypeByte & 0x0f;\r\n        event.type = 'channel';\r\n        switch (eventType) {\r\n            case 0x08:\r\n                event.subtype = 'noteOff';\r\n                event.noteNumber = param1;\r\n                event.velocity = stream.readInt8();\r\n                return event;\r\n            case 0x09:\r\n                event.noteNumber = param1;\r\n                event.velocity = stream.readInt8();\r\n                if (event.velocity == 0) {\r\n                    event.subtype = 'noteOff';\r\n                } else {\r\n                    event.subtype = 'noteOn';\r\n                }\r\n                return event;\r\n            case 0x0a:\r\n                event.subtype = 'noteAftertouch';\r\n                event.noteNumber = param1;\r\n                event.amount = stream.readInt8();\r\n                return event;\r\n            case 0x0b:\r\n                event.subtype = 'controller';\r\n                event.controllerType = param1;\r\n                event.value = stream.readInt8();\r\n                return event;\r\n            case 0x0c:\r\n                event.subtype = 'programChange';\r\n                event.programNumber = param1;\r\n                return event;\r\n            case 0x0d:\r\n                event.subtype = 'channelAftertouch';\r\n                event.amount = param1;\r\n                return event;\r\n            case 0x0e:\r\n                event.subtype = 'pitchBend';\r\n                event.value = param1 + (stream.readInt8() << 7);\r\n                return event;\r\n            default:\r\n                throw \"Unrecognised MIDI event type: \" + eventType\r\n        }\r\n    }\r\n}\r\n\r\nmodule.exports=MIDI;","/**\r\n * Created by chie on 2016/4/25.\r\n */\r\n\r\n\r\nlet MIDIPlayer = function (midiTracks) {\r\n    this.temporal = midiTracks.temporal;\r\n    this.playTime = ctx.currentTime;\r\n    this.beginTime = this.playTime;\r\n    this.masterVolume = 127;\r\n    this.sources = {};\r\n    MIDIPlayer.currentPlayer.push(this);\r\n}\r\n\r\nMIDIPlayer.prototype.sendSignal = function (x, y) {\r\n    y = y || 5;\r\n    let current = this;\r\n    for (let i = x; i < this.temporal.length && i < x + y; i++) {\r\n        switch (this.temporal[i][0].subtype) {\r\n            case 'noteOn':\r\n                this.noteOn('acoustic_grand_piano', this.temporal[i][0].noteNumber, this.temporal[i][0].velocity, this.temporal[i][1])\r\n                break;\r\n            case 'noteOff':\r\n                this.noteOff('acoustic_grand_piano', this.temporal[i][0].noteNumber, this.temporal[i][1]);\r\n                break;\r\n        }\r\n    }\r\n\r\n    if ((x + y) < this.temporal.length) {\r\n        let time = (this.temporal[(x + y)][1] - ctx.currentTime + this.beginTime) * 1000 - 500;\r\n        this.currentTimeout = setTimeout(function () {\r\n            current.playTime = ctx.currentTime;\r\n            current.sendSignal(x + y, y);\r\n        }, time);\r\n    }\r\n}\r\n\r\nMIDIPlayer.prototype.noteOn = function (instrument, noteId, velocity, delay) {\r\n    let source = ctx.createBufferSource();\r\n    source.buffer = audioBuffers[instrument + ' ' + noteId];\r\n    let ouput = ctx.createGain();\r\n    ouput.connect(ctx.destination);\r\n    ouput.gain.value = Math.min(1.0, Math.max(-1.0, (velocity / 127) * (this.masterVolume / 127)));\r\n    source.gain = ouput;\r\n    source.connect(ouput);\r\n    //此处可添加音频效果器\r\n    /*\r\n     var feedbackNode = ctx.createGain();\r\n     feedbackNode.gain.value = 1;\r\n\r\n     var filter = ctx.createBiquadFilter();\r\n     filter.frequency.value = 1000;\r\n\r\n     var delayNode = ctx.createDelay();\r\n     delayNode.delayTime.value = 0.15;\r\n\r\n     delayNode.connect(filter);\r\n     filter.connect(feedbackNode)\r\n\r\n     source.connect(delayNode);\r\n\r\n     feedbackNode.connect(ouput);\r\n     */\r\n    delay = delay - ctx.currentTime + this.playTime + this.beginTime\r\n    source.start(delay);\r\n    this.sources[noteId] = source;\r\n};\r\n\r\nMIDIPlayer.prototype.noteOff = function (instrument, noteId, delay) {\r\n    let buffer = audioBuffers[instrument + ' ' + noteId];\r\n    if (buffer) {\r\n        let source = this.sources[noteId];\r\n        if (source) {\r\n            delay = delay - ctx.currentTime + this.playTime + this.beginTime\r\n\r\n            if (source.gain) {\r\n                var gain = source.gain.gain;\r\n                gain.linearRampToValueAtTime(gain.value, delay);\r\n                gain.linearRampToValueAtTime(0, delay + 0.3);\r\n            }\r\n            this.sources[noteId] = null;\r\n            return source;\r\n        }\r\n    }\r\n}\r\n\r\nMIDIPlayer.prototype.stopAllNotes = function () {\r\n    for (var a in this.sources) {\r\n        var source = this.sources[a];\r\n        if (source && source.gain) {\r\n            var gain = source.gain.gain;\r\n            gain.linearRampToValueAtTime(gain.value, 0);\r\n            gain.linearRampToValueAtTime(0, 0 + 0.3);\r\n            source = null;\r\n        }\r\n    }\r\n}\r\n\r\nMIDIPlayer.currentPlayer = [];\r\n\r\nMIDIPlayer.clearPlayer = function () {\r\n    MIDIPlayer.currentPlayer.forEach(function (a) {\r\n        clearTimeout(a.currentTimeout)\r\n        //静音\r\n        a.stopAllNotes();\r\n    });\r\n    MIDIPlayer.currentPlayer = [];\r\n}\r\n\r\nglobal.ctx = new window.AudioContext();\r\nvar soundFont;\r\nvar audioBuffers = {};\r\nvar soundFontLength, decodeLength;\r\nvar keyToNote = {}; // C8  == 108\r\nvar noteToKey = {}; // 108 ==  C8\r\n\r\n(function () {\r\n    var A0 = 0x15; // first note\r\n    var C8 = 0x6C; // last note\r\n    var number2key = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];\r\n    for (var n = A0; n <= C8; n++) {\r\n        var octave = (n - 12) / 12 >> 0;\r\n        var name = number2key[n % 12] + octave;\r\n        keyToNote[name] = n;\r\n        noteToKey[n] = name;\r\n    }\r\n})();\r\n\r\nMIDIPlayer.loadSondFont = function (instrument, callback) {\r\n    instrument = instrument || 'acoustic_grand_piano';\r\n    decodeLength = 0;\r\n\r\n    if (typeof MIDI !== 'undefined' && MIDI.Soundfont[instrument]) { // already loaded\r\n        console.log('already cached')\r\n        callback();\r\n    } else {\r\n        var xhr = new XMLHttpRequest();\r\n\r\n        //自行更改soundfont地址\r\n        xhr.open('GET', './js/soundfont/' + instrument + '-mp3.js', true);\r\n        \r\n        xhr.onreadystatechange = function (evt) {\r\n            if (xhr.readyState === 4) {\r\n                if (xhr.status === 200 ||\r\n                    xhr.status === 304 ||    // Not Modified\r\n                    xhr.status === 308 ||    // Permanent Redirect\r\n                    xhr.status === 0 && root.client.cordova // Cordova quirk\r\n                ) {\r\n                    var script = document.createElement('script');\r\n                    script.language = 'javascript';\r\n                    script.type = 'text/javascript';\r\n                    script.text = evt.target.responseText;\r\n                    document.body.appendChild(script);\r\n                    soundFont = MIDI.Soundfont[instrument]\r\n                    soundFontLength = Object.keys(soundFont).length;\r\n                    for (var index in soundFont) {\r\n                        loadAudio(instrument, index, callback);\r\n                    }\r\n                } else {\r\n                    onerror && onerror.call(xhr, evt);\r\n                }\r\n            }\r\n        }\r\n        xhr.send();\r\n    }\r\n}\r\n\r\nfunction loadAudio(instrument, index, callback) {\r\n    var bstr = atob(soundFont[index].split(',')[1]), n = bstr.length, buffer = new ArrayBuffer(n), u8arr = new Uint8Array(buffer);\r\n    while (n--) {\r\n        u8arr[n] = bstr.charCodeAt(n);\r\n    }\r\n    ctx.decodeAudioData(buffer, function (buffer1) {\r\n        buffer1.id = keyToNote[index]\r\n        if (buffer1.id) {\r\n            audioBuffers[instrument + ' ' + buffer1.id] = buffer1;\r\n        }\r\n        if (++decodeLength === soundFontLength) {\r\n            console.log(\"finish\")\r\n            callback();\r\n        }\r\n    })\r\n}\r\n\r\nmodule.exports = MIDIPlayer;","/**\r\n * Created by chie on 2016/2/25.\r\n */\r\nfunction Stream(str) {\r\n    var position = 0;\r\n    \r\n    function readWord(length) {\r\n        \r\n        var str1=''\r\n        for(var i=0;i<length;i++){\r\n            str1+=String.fromCharCode(str[position+i])\r\n        }\r\n        position+=length;\r\n        return str1;\r\n    }\r\n    function read(length){\r\n        position+=length;\r\n        return str.slice(position-length,position)\r\n    }\r\n    //读32位，以此类推\r\n    function readInt32() {\r\n        var result = (\r\n        (str[position] << 24)\r\n        + (str[position + 1] << 16)\r\n        + (str[position + 2] << 8)\r\n        + str[position + 3]);\r\n        position += 4;\r\n        return result;\r\n    }\r\n\r\n    function readInt16() {\r\n        var result = (\r\n        (str[position] << 8)\r\n        + str[position + 1]);\r\n        position += 2;\r\n        return result;\r\n    }\r\n\r\n    function readInt8(signed) {\r\n        var result = str[position];\r\n        if (signed && result > 127) result -= 256;\r\n        position += 1;\r\n        return result;\r\n    }\r\n\r\n    function eof() {\r\n        return position >= str.length;\r\n    }\r\n    //读变长\r\n    function readVarInt() {\r\n        var result = 0;\r\n        while (true) {\r\n            var b = readInt8();\r\n            if (b & 0x80) {\r\n                result += (b & 0x7f);\r\n                result <<= 7;\r\n            } else {\r\n                return result + b;\r\n            }\r\n        }\r\n    }\r\n\r\n    return {\r\n        'eof': eof,\r\n        'read': read,\r\n        'readInt32': readInt32,\r\n        'readInt16': readInt16,\r\n        'readInt8': readInt8,\r\n        'readVarInt': readVarInt,\r\n        'readWord':readWord\r\n    }\r\n}\r\n\r\nmodule.exports=Stream;","/**\r\n * Created by chie on 2016/5/21.\r\n */\r\n\r\nglobal.MIDIPlayer=require('./js/midi/player.js');\r\nglobal.loadMidiFile=require('./js/midi/loader.js');"],"sourceRoot":"/source/"}