"use strict";!function e(t,r,n){function a(o,s){if(!r[o]){if(!t[o]){var u="function"==typeof require&&require;if(!s&&u)return u(o,!0);if(i)return i(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var d=r[o]={exports:{}};t[o][0].call(d.exports,function(e){var r=t[o][1][e];return a(r?r:e)},d,d.exports,e,t,r,n)}return r[o].exports}for(var i="function"==typeof require&&require,o=0;o<n.length;o++)a(n[o]);return a}({1:[function(e,t,r){var n=e("./midi.js"),a=function i(e,t){var r=function(e,t){var r=new FileReader;r.readAsDataURL(e),r.onloadend=function(e){return t(e.target.result)}};-1==e.constructor.toString().indexOf("File")&&-1==e.constructor.toString().indexOf("Blob")||r(e,function(e){i.midiTracks=new n(e),i.midiTracks.intoTracks(),i.midiTracks.intoTemporal(),MIDIPlayer.loadSondFont("acoustic_grand_piano",function(){return t(i.midiTracks)})})};a.midiTracks={},t.exports=a},{"./midi.js":2}],2:[function(e,t,r){var n=e("./stream"),a=function(e){this.midiDataurl=e,this.header={},this.tracks=[],this.temporal=[],this.beatsPerMinute=120};a.prototype={intoTracks:function(){if(!this.midiDataurl)throw"midiDateurl is null";for(var e=atob(this.midiDataurl.split(",")[1]),t=e.length,r=[];t--;)r[t]=e.charCodeAt(t);var a=n(r);console.log(a.readWord(4));var i=n(a.read(a.readInt32()));this.header.formatType=i.readInt16(),this.header.trackCount=i.readInt16(),this.header.ticksPerBeat=i.readInt16();for(var s=0;s<this.header.trackCount;s++){this.tracks[s]=[],console.log(a.readWord(4));for(var u=n(a.read(a.readInt32()));!u.eof();){var c=o(u);this.tracks[s].push(c)}}},intoTemporal:function(){for(var e=0,t=0,r={trackId:0,deltaTime:1/0},n=[],a=0;a<this.tracks.length;a++)n[a]={position:0,deltaTime:0};for(;;){r.deltaTime=1/0;for(var i=0;i<this.tracks.length;i++)this.tracks[i][n[i].position]&&this.tracks[i][n[i].position].deltaTime+n[i].deltaTime<r.deltaTime&&(r.trackId=i,r.deltaTime=this.tracks[i][n[i].position].deltaTime+n[i].deltaTime);if(r.deltaTime==1/0)break;var o=this.tracks[r.trackId][n[r.trackId].position];this.temporal.push([o,e+=(r.deltaTime-t)/this.header.ticksPerBeat/(this.beatsPerMinute/60)]),n[r.trackId].position++,n[r.trackId].deltaTime=r.deltaTime,t=n[r.trackId].deltaTime,"meta"==o.type&&"setTempo"==o.subtype&&(this.beatsPerMinute=6e7/o.microsecondsPerBeat)}}};var i=void 0,o=function(e){var t={};t.deltaTime=e.readVarInt();var r=e.readInt8();if(240==(240&r)){if(255==r){t.type="meta";var n=e.readInt8(),a=e.readVarInt();switch(n){case 0:if(t.subtype="sequenceNumber",2!=a)throw"Expected length for sequenceNumber event is 2, got "+a;return t.number=e.readInt16(),t;case 1:return t.subtype="text",t.text=e.read(a),t;case 2:return t.subtype="copyrightNotice",t.text=e.read(a),t;case 3:return t.subtype="trackName",t.text=e.read(a),t;case 4:return t.subtype="instrumentName",t.text=e.read(a),t;case 5:return t.subtype="lyrics",t.text=e.read(a),t;case 6:return t.subtype="marker",t.text=e.read(a),t;case 7:return t.subtype="cuePoint",t.text=e.read(a),t;case 32:if(t.subtype="midiChannelPrefix",1!=a)throw"Expected length for midiChannelPrefix event is 1, got "+a;return t.channel=e.readInt8(),t;case 47:if(t.subtype="endOfTrack",0!=a)throw"Expected length for endOfTrack event is 0, got "+a;return t;case 81:if(t.subtype="setTempo",3!=a)throw"Expected length for setTempo event is 3, got "+a;return t.microsecondsPerBeat=(e.readInt8()<<16)+(e.readInt8()<<8)+e.readInt8(),t;case 84:if(t.subtype="smpteOffset",5!=a)throw"Expected length for smpteOffset event is 5, got "+a;var o=e.readInt8();return t.frameRate={0:24,32:25,64:29,96:30}[96&o],t.hour=31&o,t.min=e.readInt8(),t.sec=e.readInt8(),t.frame=e.readInt8(),t.subframe=e.readInt8(),t;case 88:if(t.subtype="timeSignature",4!=a)throw"Expected length for timeSignature event is 4, got "+a;return t.numerator=e.readInt8(),t.denominator=Math.pow(2,e.readInt8()),t.metronome=e.readInt8(),t.thirtyseconds=e.readInt8(),t;case 89:if(t.subtype="keySignature",2!=a)throw"Expected length for keySignature event is 2, got "+a;return t.key=e.readInt8(!0),t.scale=e.readInt8(),t;case 127:return t.subtype="sequencerSpecific",t.data=e.read(a),t;default:return t.subtype="unknown",t.data=e.read(a),t}return t.data=e.read(a),t}if(240==r){t.type="sysEx";var s=e.readVarInt();return t.data=e.read(s),t}if(247==r){t.type="dividedSysEx";var u=e.readVarInt();return t.data=e.read(u),t}throw"Unrecognised MIDI event type byte: "+r}var c=void 0;0==(128&r)?(c=r,r=i):(c=e.readInt8(),i=r);var d=r>>4;switch(t.channel=15&r,t.type="channel",d){case 8:return t.subtype="noteOff",t.noteNumber=c,t.velocity=e.readInt8(),t;case 9:return t.noteNumber=c,t.velocity=e.readInt8(),0==t.velocity?t.subtype="noteOff":t.subtype="noteOn",t;case 10:return t.subtype="noteAftertouch",t.noteNumber=c,t.amount=e.readInt8(),t;case 11:return t.subtype="controller",t.controllerType=c,t.value=e.readInt8(),t;case 12:return t.subtype="programChange",t.programNumber=c,t;case 13:return t.subtype="channelAftertouch",t.amount=c,t;case 14:return t.subtype="pitchBend",t.value=c+(e.readInt8()<<7),t;default:throw"Unrecognised MIDI event type: "+d}};t.exports=a},{"./stream":4}],3:[function(e,t,r){(function(e){function r(e,t,r){for(var n=atob(a[t].split(",")[1]),c=n.length,d=new ArrayBuffer(c),l=new Uint8Array(d);c--;)l[c]=n.charCodeAt(c);ctx.decodeAudioData(d,function(n){n.id=u[t],n.id&&(s[e+" "+n.id]=n),++o===i&&(console.log("finish"),r())})}var n=function d(e){this.temporal=e.temporal,this.playTime=ctx.currentTime,this.beginTime=this.playTime,this.masterVolume=127,this.sources={},d.currentPlayer.push(this)};n.prototype.sendSignal=function(e,t){t=t||5;for(var r=this,n=e;n<this.temporal.length&&e+t>n;n++)switch(this.temporal[n][0].subtype){case"noteOn":this.noteOn("acoustic_grand_piano",this.temporal[n][0].noteNumber,this.temporal[n][0].velocity,this.temporal[n][1]);break;case"noteOff":this.noteOff("acoustic_grand_piano",this.temporal[n][0].noteNumber,this.temporal[n][1])}if(e+t<this.temporal.length){var a=1e3*(this.temporal[e+t][1]-ctx.currentTime+this.beginTime)-500;this.currentTimeout=setTimeout(function(){r.playTime=ctx.currentTime,r.sendSignal(e+t,t)},a)}},n.prototype.noteOn=function(e,t,r,n){var a=ctx.createBufferSource();a.buffer=s[e+" "+t];var i=ctx.createGain();i.connect(ctx.destination),i.gain.value=Math.min(1,Math.max(-1,r/127*(this.masterVolume/127))),a.gain=i,a.connect(i),n=n-ctx.currentTime+this.playTime+this.beginTime,a.start(n),this.sources[t]=a},n.prototype.noteOff=function(e,t,r){var n=s[e+" "+t];if(n){var a=this.sources[t];if(a){if(r=r-ctx.currentTime+this.playTime+this.beginTime,a.gain){var i=a.gain.gain;i.linearRampToValueAtTime(i.value,r),i.linearRampToValueAtTime(0,r+.3)}return this.sources[t]=null,a}}},n.prototype.stopAllNotes=function(){for(var e in this.sources){var t=this.sources[e];if(t&&t.gain){var r=t.gain.gain;r.linearRampToValueAtTime(r.value,0),r.linearRampToValueAtTime(0,.3),t=null}}},n.currentPlayer=[],n.clearPlayer=function(){n.currentPlayer.forEach(function(e){clearTimeout(e.currentTimeout),e.stopAllNotes()}),n.currentPlayer=[]},e.ctx=new window.AudioContext;var a,i,o,s={},u={},c={};!function(){for(var e=21,t=108,r=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],n=e;t>=n;n++){var a=(n-12)/12>>0,i=r[n%12]+a;u[i]=n,c[n]=i}}(),n.loadSondFont=function(e,t){if(e=e||"acoustic_grand_piano",o=0,"undefined"!=typeof MIDI&&MIDI.Soundfont[e])console.log("already cached"),t();else{var n=new XMLHttpRequest;n.open("GET","./js/soundfont/"+e+"-mp3.js",!0),n.onreadystatechange=function(o){if(4===n.readyState)if(200===n.status||304===n.status||308===n.status||0===n.status&&root.client.cordova){var s=document.createElement("script");s.language="javascript",s.type="text/javascript",s.text=o.target.responseText,document.body.appendChild(s),a=MIDI.Soundfont[e],i=Object.keys(a).length;for(var u in a)r(e,u,t)}else onerror&&onerror.call(n,o)},n.send()}},t.exports=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],4:[function(e,t,r){function n(e){function t(t){for(var r="",n=0;t>n;n++)r+=String.fromCharCode(e[u+n]);return u+=t,r}function r(t){return u+=t,e.slice(u-t,u)}function n(){var t=(e[u]<<24)+(e[u+1]<<16)+(e[u+2]<<8)+e[u+3];return u+=4,t}function a(){var t=(e[u]<<8)+e[u+1];return u+=2,t}function i(t){var r=e[u];return t&&r>127&&(r-=256),u+=1,r}function o(){return u>=e.length}function s(){for(var e=0;;){var t=i();if(!(128&t))return e+t;e+=127&t,e<<=7}}var u=0;return{eof:o,read:r,readInt32:n,readInt16:a,readInt8:i,readVarInt:s,readWord:t}}t.exports=n},{}],5:[function(e,t,r){(function(t){t.MIDIPlayer=e("./js/midi/player.js"),t.loadMidiFile=e("./js/midi/loader.js")}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./js/midi/loader.js":1,"./js/midi/player.js":3}]},{},[5]);
//# sourceMappingURL=midi.min.js.map
